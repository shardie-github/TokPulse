# Creating Experiments

Learn how to create and manage A/B tests and feature flags with TokPulse.

## Overview

Experiments in TokPulse allow you to:

- Run A/B tests on your store
- Implement feature flags
- Test different configurations
- Measure impact on key metrics

## Experiment Types

### A/B Tests

Traditional A/B tests compare two or more variants to determine which performs better.

**Example**: Testing different button colors
- Control: Blue button
- Treatment: Green button
- Metric: Click-through rate

### Feature Flags

Feature flags allow you to enable/disable features for different user segments.

**Example**: New checkout flow
- Control: Current checkout
- Treatment: New checkout flow
- Rollout: Gradual (10% → 50% → 100%)

### Configuration Tests

Test different configurations or settings.

**Example**: Product recommendation algorithm
- Control: Current algorithm
- Treatment: New ML-based algorithm
- Metric: Conversion rate

## Creating an Experiment

### 1. Basic Setup

```bash
curl -X POST http://localhost:3001/api/experiments \
  -H "Content-Type: application/json" \
  -H "X-Org-ID: your-org-id" \
  -d '{
    "key": "checkout_flow_test",
    "name": "Checkout Flow Test",
    "description": "Test new checkout flow vs current",
    "allocation": 100,
    "variants": [
      {
        "key": "control",
        "name": "Current Flow",
        "weight": 50,
        "configJson": "{\"flow\": \"current\"}"
      },
      {
        "key": "treatment",
        "name": "New Flow",
        "weight": 50,
        "configJson": "{\"flow\": \"new\", \"steps\": 3}"
      }
    ]
  }'
```

### 2. Advanced Configuration

```json
{
  "key": "pricing_display_test",
  "name": "Pricing Display Test",
  "description": "Test different pricing display formats",
  "startAt": "2024-02-01T00:00:00Z",
  "stopAt": "2024-02-28T23:59:59Z",
  "allocation": 50,
  "guardrailMetric": "error_rate",
  "variants": [
    {
      "key": "control",
      "name": "Standard Pricing",
      "weight": 33,
      "configJson": "{\"format\": \"standard\", \"showDiscount\": true}"
    },
    {
      "key": "treatment_a",
      "name": "Compact Pricing",
      "weight": 33,
      "configJson": "{\"format\": \"compact\", \"showDiscount\": false}"
    },
    {
      "key": "treatment_b",
      "name": "Detailed Pricing",
      "weight": 34,
      "configJson": "{\"format\": \"detailed\", \"showBreakdown\": true}"
    }
  ]
}
```

## Variant Configuration

### Configuration JSON

Each variant can include custom configuration:

```json
{
  "key": "button_test",
  "name": "Button Test",
  "weight": 50,
  "configJson": "{
    \"color\": \"#3B82F6\",
    \"size\": \"large\",
    \"text\": \"Buy Now\",
    \"animation\": \"pulse\",
    \"position\": \"sticky\"
  }"
}
```

### Common Configuration Patterns

**UI Changes**:
```json
{
  "theme": {
    "primaryColor": "#3B82F6",
    "fontSize": "16px",
    "borderRadius": "8px"
  }
}
```

**Feature Toggles**:
```json
{
  "features": {
    "newCheckout": true,
    "recommendations": false,
    "liveChat": true
  }
}
```

**Content Variations**:
```json
{
  "content": {
    "headline": "Get 50% Off Today!",
    "subheadline": "Limited time offer",
    "ctaText": "Shop Now"
  }
}
```

## Assignment Logic

### Deterministic Hashing

TokPulse uses deterministic hashing to ensure consistent assignments:

```javascript
// Assignment is based on:
// hash(subjectKey + experimentKey + hashSalt) % 100 < weight
const assignment = hash(`${subjectKey}:${experimentKey}:${hashSalt}`) % 100
const variant = assignment < weight ? 'treatment' : 'control'
```

### Subject Keys

The subject key determines which variant a user gets:

- **Customer ID**: For logged-in users
- **Session ID**: For anonymous users
- **Anonymous ID**: Fallback identifier

```javascript
// Priority order:
const subjectKey = customerId || sessionId || anonId
```

## Using Experiments

### In Theme Templates

```liquid
{% comment %} Get experiment assignment {% endcomment %}
<script>
  TokPulseExperiments.getExperimentConfig('button_test', 'theme')
    .then(config => {
      if (config) {
        // Apply configuration
        document.querySelector('.cta-button').style.backgroundColor = config.color;
        document.querySelector('.cta-button').textContent = config.text;
      }
    });
</script>
```

### In Hydrogen

```tsx
import { useExperiment } from '@tokpulse/experiments'

function ProductPage() {
  const { variant, isAssigned } = useExperiment({
    experimentKey: 'product_layout_test',
    fallback: { layout: 'grid' }
  })

  if (!isAssigned) {
    return <ProductGrid layout="grid" />
  }

  return <ProductGrid layout={variant.layout} />
}
```

### In React Components

```tsx
import { ExperimentComponent } from '@tokpulse/experiments'

function CheckoutButton() {
  return (
    <ExperimentComponent
      experimentKey="checkout_button_test"
      variantA={<button className="btn-primary">Checkout</button>}
      variantB={<button className="btn-success">Complete Purchase</button>}
    />
  )
}
```

## Monitoring Experiments

### Key Metrics

Track these metrics for your experiments:

- **Assignment Rate**: Percentage of users assigned to variants
- **Exposure Rate**: Percentage of users who see the experiment
- **Conversion Rate**: Primary success metric
- **Error Rate**: Technical issues and failures

### Guardrails

Set up guardrails to automatically pause experiments:

```json
{
  "guardrailMetric": "error_rate",
  "threshold": 0.05,
  "action": "pause"
}
```

Common guardrail metrics:
- `error_rate`: Technical error rate
- `bounce_rate`: User engagement
- `conversion_rate`: Business impact
- `page_load_time`: Performance

### Dashboard

View experiment performance in the TokPulse dashboard:

1. **Overview**: All experiments and their status
2. **Details**: Individual experiment metrics
3. **Variants**: Performance comparison
4. **Timeline**: Assignment and exposure over time

## Best Practices

### Experiment Design

1. **Clear Hypothesis**: Define what you're testing and why
2. **Single Variable**: Test one change at a time
3. **Statistical Significance**: Ensure adequate sample size
4. **Duration**: Run for at least one business cycle

### Configuration

1. **Fallbacks**: Always provide fallback behavior
2. **Validation**: Validate configuration JSON
3. **Testing**: Test variants before launching
4. **Monitoring**: Set up alerts and guardrails

### Rollout Strategy

1. **Gradual Rollout**: Start with small allocation
2. **Monitor Closely**: Watch for issues early
3. **A/B Test First**: Test before full rollout
4. **Document Results**: Record learnings and decisions

## Troubleshooting

### Common Issues

**Experiment not assigning**:
- Check experiment status (must be RUNNING)
- Verify subject key is being passed
- Check allocation percentage

**Inconsistent assignments**:
- Ensure same subject key across requests
- Check for caching issues
- Verify hash salt consistency

**Configuration not applying**:
- Validate JSON configuration
- Check for JavaScript errors
- Verify experiment key spelling

### Debug Mode

Enable debug mode to see assignment details:

```javascript
// Enable debug logging
window.TokPulseExperiments.debug = true

// Check assignment
TokPulseExperiments.getAssignment('experiment_key')
  .then(assignment => console.log('Assignment:', assignment))
```

## Next Steps

- [A/B Testing Guide](/experiments/ab-testing)
- [Feature Flags](/experiments/feature-flags)
- [Guardrails](/experiments/guardrails)
- [API Reference](/api/experiments)